name: Build Kivy App for Linux (.deb)

on:
  push:
    branches: [ main ]
  release:
    types: [created]

jobs:
  build-deb:
    runs-on: ubuntu-latest

    steps:
      # 1. Получаем код
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Настраиваем Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3. Устанавливаем системные зависимости
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip python3-dev build-essential \
            libsdl2-dev libmtdev-dev libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev libgl1-mesa-dev \
            libgles2-mesa-dev libjpeg-dev libpng-dev \
            libavformat-dev libswscale-dev libxrandr-dev \
            libxi-dev libxcursor-dev libxinerama-dev \
            libxcomposite-dev libffi-dev libssl-dev \
            pkg-config ruby ruby-dev rubygems \
            xclip xsel  # ← ДОБАВЬТЕ ЭТО для буфера обмена
          sudo gem install fpm

      # 4. Устанавливаем зависимости Python
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip wheel setuptools
          pip install pyinstaller cython
          pip install kivy[full]==2.3.0 kivymd==1.2.0  # ← ЯВНО укажите версии
          pip install numpy sympy mpmath
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
          # Проверяем установку KivyMD
          python3 -c "import kivymd; print('KivyMD version:', kivymd.__version__); print('Path:', kivymd.__file__)"

      # 5.1: Создаем хуки для KivyMD (НОВЫЙ ШАГ)
      - name: Create PyInstaller hooks for KivyMD
        run: |
          mkdir -p hooks
          cat > hooks/hook-kivymd.py << 'EOF'
          from PyInstaller.utils.hooks import collect_data_files, collect_submodules
          
          datas = []
          try:
              datas += collect_data_files('kivymd.icon_definitions', include_py_files=True)
          except:
              pass
              
          try:
              datas += collect_data_files('kivymd.fonts', include_py_files=True)
          except:
              pass
          
          hiddenimports = [
              'kivymd',
              'kivymd.icon_definitions',
              'kivymd.icon_definitions.md_icons',
          ]
          
          # Пробуем найти все модули KivyMD
          try:
              hiddenimports += collect_submodules('kivymd')
          except:
              pass
          EOF

      # 5.2: Собираем исполняемый файл (ИСПРАВЛЕННЫЙ)
      - name: Build executable with PyInstaller
        run: |
          # Убедимся, что все зависимости на месте
          echo "Checking Python path..."
          python3 -c "import sys; print('Python path:', sys.path[:3])"
          
          # Собираем с ВСЕМИ нужными hidden-imports
          pyinstaller --onefile \
            --name=graphbuilder \
            --add-data="*.py:." \
            --add-data="*.kv:." \
            --additional-hooks-dir=hooks \
            --hidden-import=kivy \
            --hidden-import=kivymd \
            --hidden-import='kivymd.icon_definitions' \
            --hidden-import='kivymd.icon_definitions.md_icons' \
            --hidden-import='kivymd.uix.label' \
            --hidden-import='kivymd.uix.button' \
            --hidden-import='kivymd.uix.behaviors' \
            --hidden-import=numpy \
            --hidden-import=sympy \
            --hidden-import=mpmath \
            --hidden-import=pkg_resources.py2_warn \
            --clean \
            main.py

      # 5.3: Проверяем собранный файл (НОВЫЙ ШАГ)
      - name: Test the built executable
        run: |
          echo "=== Testing executable ==="
          if [ -f dist/graphbuilder ]; then
            echo "✓ File exists: $(ls -lh dist/graphbuilder)"
            
            # Пробуем получить версию или help
            echo "--- Trying to run with --version ---"
            timeout 3 ./dist/graphbuilder --version 2>&1 | head -30 || true
            
            echo "--- Checking imports in binary ---"
            # Быстрая проверка через strings
            strings dist/graphbuilder | grep -i "kivy\|icon" | head -10 || true
            
          else
            echo "✗ Executable not found!"
            exit 1
          fi

      # 6. Создаём .deb пакет
      - name: Create .deb package with FPM
        run: |
          mkdir -p fpm-package/usr/bin
          mkdir -p fpm-package/usr/share/applications
          mkdir -p fpm-package/usr/share/icons/hicolor/48x48/apps
          
          cp dist/graphbuilder fpm-package/usr/bin/
          chmod 755 fpm-package/usr/bin/graphbuilder
          
          # Создаем .desktop файл (ВАЖНО для меню)
          cat > fpm-package/usr/share/applications/graphbuilder.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=GraphBuilder
          Comment=Build and analyze graphs
          Exec=graphbuilder
          Icon=graphbuilder
          Categories=Education;Science;Math;
          Terminal=false
          EOF
          
          # Простая иконка (можно заменить на свою)
          echo "iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAANQSURBVGje7ZpLaFxVGMf/5547c2cyaZsmTQutFcRa61J8gCJuBLuQiqKoK7tQcCPShaIiCnYhCEJXgotSFB+IC0WwKx8LYyHdWCouFKWVlqR5NM1kJpnHvXN9NOl0MjN35t47SdLd/b64cOZ+93zf+Z9zzz33nAPcstu2i3YDqjHc8j8Z6/+08IrvKVXh9ub/X6hK1MpVAdY/f1odVlXp6/1fxuQvq4O6agMbl7+WU26YQjV2f3v/WTl69ZmhB97r3Xngg8HG0N0dO0I7W2Id2BXuBABcyVzFdOoaZlLXcCW9gMvpBfz9z8wf/8z+8fn8r5+8B2ARQFrZgHGlhqor7x89+PHwnmff7msafKvR0waNBgDAlWwCttBKm+dS1xBPx/Hz0h/4dv6n8fivHz0H4GJZQGX5Bx49+uW9/fs+2d2083mNGnQaqF3G9uJ6Nol4Oo4fF8/gmytfH/3nl4/fAfCXFGBr4P7y7w8e+vyBgf2fDTYOvabTQCD5wuqYSmPYEAayIovZdBy/XP8dX1756vDF8yfHACxtCbT1K3fo8Td/emRw3/E9zQ+8TqPZtvwKA9CoBo0Gvrn63d1/nBs/AuDM5hRsa4AHn3jz+0cG9x3f3dz/uk6jIvnCAcDVzALOLk7gqyvf7J84/8kYgJlCgG6j4tATb/706I4nP9jT3P86jSZfPgWpRg0cABPFryvncPri5NMTE+NjAK5sDnLdA7x34NCpZ3Y/fWJPc/9rOg1Vk7cdARrVuCHyaG90I2UksJieTwG4sflplT5V6TSAJw+Oft3f0veaTkNOXr69fG4KLLiX8VdiEj/On349/vvJdwBc2pz2dG1T2aGn3/l9f//e4/2hO1/UacjJl5PP6wogQCcNjQ0teLZ9GNrA3hMA9gNo2gIY7Hvy2P6d+14dbOx5SachRz4on8IAa2IJF9JTuJCegmGaONi7B6/c9SQA7AWwAwBB97DxwvBLx17oe+q1HY1tL+g05MmvJZ+bQyX5dWFivTmYx8c/eJ1GU9O96Hri+f5gC14e2Y8Xh19Gb6i7FwAXI88df65355FX+xrbntdpyMmXk88vXyk/T7PWrpHgK3eN5OS7/G1o87ehNdCC8cWzmF65OJ34+/Q3AGZFqKu7q7t1x1M6DTn5cvKF8vm3sLR8Tr4gv5AN4cH+HpxZnEQ8HUfWzOLY5HuIp+OYz8zj3MIfxy/8dep9AOcYYP8L9w4PDHT39ek0uOw9v1J+XiobUI0GjNxzEKdvfI3J5fNl9X7L/QIgCGD30N3DI/5G/w6dhnz5auTnjcGAa9kbeP+vd/HZhZOYSc6Uldc1PQCgA0CLZVktPo8vrNNQs3xhc3AsZ1fw/eJPOLN4Fgsb8fk8+QIGAgbq9/oBwOPz+Lw6DdSUfGEzzTeyOLt0FudTf+FKehE3NpLF8kUL3O8PwK25oDm5bvnCT2Y+nx+6SwcAXM8kl4vlC8Pkgk5dF4C4afK2A+OZxMQ4gEkAZrnl5JKHXgEAG9nMeibraK3PLk0fBXBUJfDCYw1sAAsAJgCcB3Cj3IBLnrGurKyMArjgCCDgmFTOwBUAvwGYqCSfM2B6enq0vr4+Zc1PRwDWACwC+B3AHIAUgEy58tLa29vbX2trawOAhHMA5qoFAGcAXFNpXHjjcB7AcQAp1cCFJ0FpAMuqgQuPJNYAXAGwohq4cIexAeASgHnVwOVOc9IArgJYUw1cqWONRqMxr9fLOo2q8rZlAqZponjNFAqF4ro1B1KpVKzWpzc9Ho+PUnpBCHF3NQZc13WPRqPm8eXl5ei/gHXDswdB8kYAAAAASUVORK5CYII=" | base64 -d > fpm-package/usr/share/icons/hicolor/48x48/apps/graphbuilder.png
          
          fpm -s dir -t deb \
            -n graphbuilder \
            -v 1.0.0-${{ github.run_number }} \
            -C fpm-package \
            --description "Graph Builder Application (Kivy/KivyMD)" \
            --maintainer "Your Name <your.email@example.com>" \
            --depends "python3" \
            --depends "python3-pip" \
            --depends "libsdl2-2.0-0" \
            --depends "libmtdev1" \
            --depends "gstreamer1.0-plugins-base" \
            --depends "libgl1" \
            --depends "xclip" \
            --depends "xsel" \
            --deb-no-default-config-files \
            usr

      # 7. Загружаем артефакты
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-package
          path: |
            dist/graphbuilder
            graphbuilder_*.deb
            hooks/
