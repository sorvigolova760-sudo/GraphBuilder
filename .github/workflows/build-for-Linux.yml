name: Build Kivy App for Linux (.deb)

on:
  push:
    branches: [ main ]
  release:
    types: [created]

jobs:
  build-deb:
    runs-on: ubuntu-latest

    steps:
      # 1. Получаем код
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Настраиваем Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3. Устанавливаем системные зависимости (ИСПРАВЛЕНО)
      - name: Install system dependencies
        run: |
          sudo apt-get update
          # Устанавливаем системные зависимости для сборки и FPM
          sudo apt-get install -y \
            python3-pip python3-dev build-essential \
            libsdl2-dev libmtdev-dev libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev libgl1-mesa-dev \
            libgles2-mesa-dev libjpeg-dev libpng-dev \
            libavformat-dev libswscale-dev libxrandr-dev \
            libxi-dev libxcursor-dev libxinerama-dev \
            libxcomposite-dev libffi-dev libssl-dev \
            pkg-config ruby ruby-dev rubygems
          # Устанавливаем FPM через RubyGems
          sudo gem install fpm

      # 4. Устанавливаем зависимости Python
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip wheel setuptools
          pip install pyinstaller cython
          # Основные зависимости для твоего приложения
          pip install kivy[full] kivymd numpy sympy
          # Дополнительно устанавливаем всё из requirements.txt (если он есть)
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 5. Собираем исполняемый файл с PyInstaller
      - name: Build executable with PyInstaller
        run: |
          pyinstaller --onefile \
            --name=myapp \
            --add-data="*.py:." \
            --add-data="*.kv:." \
            --hidden-import=kivy \
            --hidden-import=kivymd \
            --hidden-import=numpy \
            --hidden-import=sympy \
            main.py

      # 6. Создаём структуру пакета .deb с помощью FPM
      - name: Create .deb package with FPM
        run: |
          # Создаём временную структуру для FPM
          mkdir -p fpm-package/usr/bin
          mkdir -p fpm-package/usr/share/myapp
          
          # Копируем собранный бинарник
          cp dist/myapp fpm-package/usr/bin/
          chmod 755 fpm-package/usr/bin/myapp
          
          # Создаём .deb пакет с помощью FPM
          fpm -s dir -t deb \
            -n myapp \
            -v 1.0.0-${{ github.run_number }} \
            -C fpm-package \
            --description "Graph Builder Application (Kivy)" \
            --maintainer "Your Name <your.email@example.com>" \
            --depends "python3" \
            --depends "libsdl2-2.0-0" \
            --depends "libmtdev1" \
            --depends "gstreamer1.0-plugins-base" \
            --depends "libgl1" \
            --deb-no-default-config-files \
            usr
          
          echo "Package created:"
          ls -lh *.deb

      # 7. Загружаем артефакты (исполняемый файл и .deb пакет)
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-package
          path: |
            dist/myapp
            myapp_*.deb