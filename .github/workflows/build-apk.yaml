name: Build Kivy APK

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git zip unzip wget \
          openjdk-17-jdk \
          python3-pip \
          autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev \
          libtinfo5 cmake libffi-dev libssl-dev

    - name: Install Buildozer and Cython
      run: |
        python -m pip install --upgrade pip
        pip install "buildozer==1.5.0" "cython==0.29.36"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¥ Ğ•Ğ”Ğ˜ĞĞ¡Ğ¢Ğ’Ğ•ĞĞĞ«Ğ™ BOOTSTRAP-Ğ¨ĞĞ“: SDK + LICENSES
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Bootstrap Android SDK and accept licenses
      run: |
        set -euo pipefail

        SDKROOT="$HOME/.buildozer/android/platform/android-sdk"

        echo "== 1) Trigger buildozer to create SDK structure =="
        buildozer android debug || true

        echo "== 2) Ensure cmdline-tools (sdkmanager) =="
        if [ ! -x "$SDKROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
          echo "sdkmanager not found, downloading cmdline-tools manually"
          mkdir -p "$SDKROOT/cmdline-tools"
          cd /tmp
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-latest.zip
          unzip -q commandlinetools-linux-latest.zip
          mv cmdline-tools "$SDKROOT/cmdline-tools/latest"
        fi

        SDKMANAGER="$SDKROOT/cmdline-tools/latest/bin/sdkmanager"
        chmod +x "$SDKMANAGER"

        echo "== 3) Accept ALL Android SDK licenses =="
        yes | "$SDKMANAGER" --licenses

        echo "== 4) Install required SDK packages =="
        "$SDKMANAGER" \
          "platforms;android-33" \
          "build-tools;35.0.0" \
          --sdk_root="$SDKROOT"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # âœ… Ğ§Ğ˜Ğ¡Ğ¢ĞĞ¯ Ğ¡Ğ‘ĞĞ ĞšĞ (Ğ›Ğ˜Ğ¦Ğ•ĞĞ—Ğ˜Ğ™ Ğ‘ĞĞ›Ğ¬Ğ¨Ğ• ĞĞ• Ğ‘Ğ£Ğ”Ğ•Ğ¢)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build APK
      run: |
        buildozer android debug

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: kivy-apk
        path: bin/*.apk
