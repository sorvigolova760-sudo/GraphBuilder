name: Build Android APK

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Configure needrestart to avoid interactive prompts
        run: |
          sudo apt-get update
          sudo apt-get install -y debconf-utils
          echo 'needrestart needrestart/restart-services string' | sudo debconf-set-selections
          echo 'needrestart needrestart/restart-suggestions string' | sudo debconf-set-selections

      - name: Install system dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get install -y \
            python3-pip \
            openjdk-17-jdk \
            git \
            build-essential \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            autoconf \
            automake \
            libtool \
            pkg-config \
            gettext

      - name: Install Buildozer and Cython
        run: pip3 install buildozer cython==0.29.33

      - name: Clean previous builds
        run: rm -rf .buildozer || true

      - name: Ensure buildozer.spec exists
        run: |
          if [ ! -f "buildozer.spec" ]; then
            echo "❌ ERROR: buildozer.spec not found in repository root!" >&2
            exit 1
          fi
          echo "✅ buildozer.spec is present."

      - name: Download Android SDK and accept licenses
        run: |
          export BUILDOZER_ALLOW_ROOT=1
          echo "Downloading Android SDK..."
          yes | buildozer android update sdk --no-ui 2>/dev/null || true

          if [ -d "$HOME/.buildozer/android/platform/android-sdk" ]; then
            echo "Accepting SDK licenses..."
            cd "$HOME/.buildozer/android/platform/android-sdk"
            yes | ./tools/bin/sdkmanager --licenses 2>/dev/null || true
            echo "Licenses accepted."
          else
            echo "⚠️ Warning: Android SDK not found at expected path."
          fi

      - name: Patch libffi to fix LT_SYS_SYMBOL_USCORE
        run: |
          export BUILDOZER_ALLOW_ROOT=1
          echo "Triggering source extraction (will time out intentionally)..."
          timeout 60s buildozer android debug 2>/dev/null || true

          echo "Patching configure.ac in libffi..."
          FOUND=0
          while IFS= read -r -d '' file; do
            echo "  → Patching $file"
            sed -i 's/LT_SYS_SYMBOL_USCORE/#LT_SYS_SYMBOL_USCORE/g' "$file"
            FOUND=1
          done < <(find . -path "*/libffi*/configure.ac" -print0)

          if [ "$FOUND" -eq 0 ]; then
            echo "⚠️ No libffi configure.ac found — patch skipped."
          else
            echo "✅ libffi patched successfully."
          fi

      - name: Remove sympy patch incompatible with v1.9
        run: rm -f $HOME/.buildozer/android/platform/python-for-android/pythonforandroid/recipes/sympy/*.patch

      - name: Build APK
        run: |
          export BUILDOZER_ALLOW_ROOT=1
          echo "Starting final APK build..."
          buildozer android debug

      - name: Check for APK
        run: |
          echo "Looking for APK files in bin/..."
          ls -la bin/ 2>/dev/null || echo "bin/ directory not found"
          find bin -name "*.apk" -type f || echo "No APK found"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: bin/*.apk
          if-no-files-found: warn