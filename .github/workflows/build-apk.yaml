name: Build Android App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-android:
    name: Build for Android
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create custom Docker container
      run: |
        cat > Dockerfile << 'EOF'
        FROM docker:latest
        
        # Устанавливаем зависимости
        RUN apk add --no-cache \
            python3 py3-pip git build-base \
            openjdk11 wget unzip \
            sdl2 sdl2_image sdl2_mixer sdl2_ttf
        
        # Устанавливаем Buildozer
        RUN pip3 install buildozer cython==0.29.33
        
        # Создаем скрипт запуска без chown
        RUN cat > /build.sh << 'SCRIPT'
        #!/bin/sh
        cd /github/workspace
        buildozer android debug
        SCRIPT
        
        RUN chmod +x /build.sh
        EOF
        
        docker build -t custom-buildozer .
        
    - name: Run Buildozer
      run: |
        docker run --rm \
          -v $GITHUB_WORKSPACE:/github/workspace \
          -w /github/workspace \
          custom-buildozer \
          /build.sh
          
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-app
        path: bin/*.apk