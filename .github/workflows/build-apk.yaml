name: Build Android App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-android:
    name: Build for Android
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Patch buildozer-action
      run: |
        # Скачиваем и патчим action локально
        mkdir -p .github/actions
        cd .github/actions
        
        # Клонируем репозиторий action
        git clone https://github.com/ArtemSBulgakov/buildozer-action.git buildozer-patched
        cd buildozer-patched
        
        # Патчим entrypoint.py чтобы убрать chown
        sed -i "s/change_owner(env\[\"USER\"\], repository_root)/# change_owner(env[\"USER\"], repository_root)/g" /action/entrypoint.py
        sed -i "s/subprocess.check_call(\[\"sudo\", \"chown\", \"-R\", user, repository_root\])/# subprocess.check_call([\"sudo\", \"chown\", \"-R\", user, repository_root])/g" /action/entrypoint.py
        
    - name: Build with patched Buildozer
      uses: ./.github/actions/buildozer-patched
      id: buildozer
      with:
        workdir: '.'
        buildozer_version: stable
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-app
        path: ${{ steps.buildozer.outputs.filename }}