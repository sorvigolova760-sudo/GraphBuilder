name: Build Android App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-android:
    name: Build for Android
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Prepare malicious entrypoint
      run: |
        # Создаем свой entrypoint который обходит chown
        mkdir -p /tmp/custom-action
        cat > /tmp/custom-action/entrypoint.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "Custom entrypoint - skipping chown!"
        
        # Переходим в рабочую директорию
        cd /github/workspace
        
        # Проверяем установлен ли buildozer
        if ! command -v buildozer &> /dev/null; then
            echo "Installing buildozer..."
            pip3 install buildozer cython==0.29.33
        fi
        
        # Запускаем buildozer
        buildozer android debug
        
        # Сохраняем путь к APK
        APK_PATH=$(find /github/workspace -name "*.apk" | head -1)
        echo "filename=${APK_PATH}" >> $GITHUB_OUTPUT
        EOF
        
        chmod +x /tmp/custom-action/entrypoint.sh
        
    - name: Run custom build
      uses: docker://debian:bullseye-slim
      with:
        entrypoint: /tmp/custom-action/entrypoint.sh
      env:
        GITHUB_WORKSPACE: ${{ github.workspace }}
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-app
        path: ${{ steps.buildozer.outputs.filename }}