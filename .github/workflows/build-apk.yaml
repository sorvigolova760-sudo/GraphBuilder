name: Build Android APK

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
            python3-pip \
            python3-venv \
            openjdk-17-jdk \
            zip \
            unzip \
            git \
            build-essential \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev
    
    - name: Install Buildozer
      run: pip3 install buildozer cython==0.29.33
    
    - name: Setup Buildozer and accept licenses BEFORE build
      run: |
        # Инициализируем buildozer если нужно
        if [ ! -f "buildozer.spec" ]; then
          buildozer init
        fi
        
        # Сначала запускаем buildozer, чтобы он скачал SDK
        # Используем yes для автоматического принятия лицензий
        echo "Downloading Android SDK..."
        yes | buildozer android update sdk --no-ui 2>&1 | tail -50 || true
        
        # Альтернативный способ принять лицензии
        if [ -d "$HOME/.buildozer/android/platform/android-sdk" ]; then
          echo "Accepting SDK licenses..."
          cd $HOME/.buildozer/android/platform/android-sdk
          yes | ./tools/bin/sdkmanager --licenses 2>/dev/null || true
          yes | ./tools/bin/sdkmanager --update 2>&1 | tail -20 || true
        fi
    
    - name: Build APK
      run: |
        export BUILDOZER_ALLOW_ROOT=1
        echo "Building APK..."
        buildozer android debug 2>&1
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk