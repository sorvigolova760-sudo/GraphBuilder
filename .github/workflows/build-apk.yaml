name: Build Android APK

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure needrestart BEFORE installation
      run: |
        # Конфигурируем needrestart ДО установки пакетов
        sudo apt-get update
        sudo apt-get install -y debconf-utils
        echo 'needrestart needrestart/restart-services string' | sudo debconf-set-selections
        echo 'needrestart needrestart/restart-suggestions string' | sudo debconf-set-selections
        echo 'needrestart needrestart/restart-common string' | sudo debconf-set-selections
    
    - name: Install dependencies with specific autotools versions
      run: |
        # Используем noninteractive режим
        export DEBIAN_FRONTEND=noninteractive
        
        sudo apt-get install -y \
            python3-pip \
            python3-venv \
            openjdk-17-jdk \
            zip \
            unzip \
            git \
            build-essential \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            # Ключевое исправление: старые версии autotools
            autoconf=2.69* \
            automake=1:1.16* \
            libtool=2.4.6* \
            pkg-config \
            gettext
    
    - name: Install Buildozer
      run: pip3 install buildozer cython==0.29.33
    
    - name: Clean previous builds
      run: rm -rf .buildozer || true
    
    - name: Setup Buildozer and accept licenses BEFORE build
      run: |
        # Инициализируем buildozer если нужно
        if [ ! -f "buildozer.spec" ]; then
          buildozer init
        fi
        
        # Сначала запускаем buildozer, чтобы он скачал SDK
        # Используем yes для автоматического принятия лицензий
        echo "Downloading Android SDK..."
        yes | buildozer android update sdk --no-ui 2>&1 | tail -50 || true
        
        # Альтернативный способ принять лицензии
        if [ -d "$HOME/.buildozer/android/platform/android-sdk" ]; then
          echo "Accepting SDK licenses..."
          cd $HOME/.buildozer/android/platform/android-sdk
          yes | ./tools/bin/sdkmanager --licenses 2>/dev/null || true
          yes | ./tools/bin/sdkmanager --update 2>&1 | tail -20 || true
        fi
    
    - name: Build APK with libffi fix
      run: |
        export BUILDOZER_ALLOW_ROOT=1
        
        # Пробуем собрать с несколькими попытками
        for attempt in {1..3}; do
          echo "Build attempt $attempt/3..."
          buildozer android debug 2>&1 && break
          
          # Если сборка упала, проверяем ошибку libffi
          if [ $attempt -lt 3 ]; then
            echo "Build failed, cleaning and retrying in 5 seconds..."
            rm -rf .buildozer/android/platform/build-* 2>/dev/null || true
            sleep 5
          fi
        done
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        if-no-files-found: warn