name: Build APK
on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup directories
        run: |
          mkdir -p .buildozer bin
          chmod 777 .buildozer bin

      - name: Build Docker image
        run: |
          docker build -t myapp-builder .

      - name: Download Android SDK/NDK (кэшируемый шаг)
        id: download-sdk
        run: |
          docker run --rm \
            -v "$(pwd):/app" \
            -w /app \
            -e BUILDOZER_NONINTERACTIVE=1 \
            myapp-builder \
            bash -c "
              echo '=== Шаг 1: Подготовка SDK/NDK ==='
              
              if [ ! -f 'buildozer.spec' ]; then
                buildozer init
                echo '' >> buildozer.spec
                echo '# Android settings' >> buildozer.spec
                echo 'android.api = 33' >> buildozer.spec
                echo 'android.minapi = 21' >> buildozer.spec
                echo 'android.ndk = 25b' >> buildozer.spec
                echo 'android.sdk = 33' >> buildozer.spec
                echo 'android.accept_sdk_license = True' >> buildozer.spec
              fi
              
              echo 'Запускаем подготовку Android SDK/NDK...'
              # Только скачиваем SDK, не собираем APK
              buildozer android update sdk ndk -v 2>&1 | while IFS= read -r line; do
                echo \"\$line\"
                if [[ \"\$line\" == *\"Downloading\"* ]] || [[ \"\$line\" == *\"Unpacking\"* ]]; then
                  echo \"[SDK/NDK Progress] \$line\"
                fi
              done
              
              echo 'Проверяем скачанные файлы SDK...'
              if [ -d '.buildozer/android/platform/android-sdk' ]; then
                echo 'SDK найдена, список build-tools:'
                ls -la .buildozer/android/platform/android-sdk/build-tools/ 2>/dev/null || echo 'build-tools еще не скачаны'
              else
                echo 'SDK не найдена'
                exit 1
              fi
            "

      - name: Build APK (основная сборка)
        id: build-apk
        run: |
          docker run --rm \
            -v "$(pwd):/app" \
            -w /app \
            -e BUILDOZER_NONINTERACTIVE=1 \
            myapp-builder \
            bash -c "
              echo '=== Шаг 2: Сборка APK ==='
              
              echo 'Очистка предыдущих сборок...'
              buildozer android clean 2>/dev/null || true
              
              echo 'Запускаем сборку APK...'
              # Теперь сборка должна быть быстрее, так как SDK уже есть
              buildozer android debug 2>&1 | while IFS= read -r line; do
                echo \"\$line\"
                if [[ \"\$line\" == *\"running\"* ]] && [[ \"\$line\" == *\"compile\"* ]]; then
                  echo \"[Build Progress] \$line\"
                fi
              done
              
              echo -e '\n=== Результат сборки ==='
              if [ -d 'bin' ]; then
                echo 'Найденные APK файлы:'
                find bin/ -name '*.apk' -type f
                ls -lh bin/*.apk 2>/dev/null || echo 'APK не создан'
              else
                echo 'Сборка не удалась - папка bin не создана'
                exit 1
              fi
            "

      - name: Upload APK
        if: steps.build-apk.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: bin/*.apk
          retention-days: 7

      - name: Debug if SDK download failed
        if: steps.download-sdk.outcome == 'failure'
        run: |
          echo '=== Ошибка при скачивании SDK/NDK ==='
          echo 'Содержимое .buildozer:'
          ls -la .buildozer/ 2>/dev/null || echo 'Папка .buildozer не существует'
          echo ''
          echo 'Логи SDK:'
          find .buildozer -name "*.log" -type f -exec tail -50 {} \; 2>/dev/null || echo 'Логи не найдены'

      - name: Debug if build failed
        if: steps.build-apk.outcome == 'failure' && steps.download-sdk.outcome == 'success'
        run: |
          echo '=== Ошибка при сборке APK (SDK была скачана) ==='
          echo 'Проверяем наличие SDK:'
          ls -la .buildozer/android/platform/android-sdk/build-tools/*/aidl 2>/dev/null && echo 'aidl найден!' || echo 'aidl НЕ найден'
          echo ''
          echo 'Последние логи сборки:'
          tail -200 .buildozer/android/platform/build-*/buildozer.log 2>/dev/null || echo 'Файл логов не найден'