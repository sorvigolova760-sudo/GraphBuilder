name: üì± Build Android APK

on:
  workflow_dispatch:  # –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ UI GitHub
  push:
    tags:
      - 'v*'          # –ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–≥–∞ v1.0, v2.0 –∏ —Ç.–¥.

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # –ë–∏–ª–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ª–≥–∏–º
    
    steps:
    # 1. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python
    - name: üêç Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11.14"
        cache: 'pip'
    
    # 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - name: ‚öôÔ∏è Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          python3-pip \
          python3-venv \
          libffi-dev \
          libssl-dev \
          libjpeg-dev \
          libz-dev \
          libsqlite3-dev \
          ccache \
          autoconf \
          automake \
          libtool \
          pkg-config \
          cmake \
          ninja-build
    
    # 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Buildozer –∏ Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - name: üì¶ Install Buildozer & Python packages
      run: |
        pip install --upgrade pip setuptools wheel
        pip install buildozer
        pip install 'cython<3.0.0'
        
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
    
    # 5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Android
    - name: ü§ñ Setup Android environment
      env:
        ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      run: |
        # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è SDK
        mkdir -p $ANDROID_SDK_ROOT
        
        # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        
        # –î–æ–±–∞–≤–∏—Ç—å –≤ PATH
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
    
    # 6. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Android SDK (—á–µ—Ä–µ–∑ GitHub Action)
    - name: üì± Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 'latest'
        build-tools-version: '34.0.0'
        platform-version: '34'
        ndk-version: '25b'
        cmake-version: '3.22.1'
    
    # 7. –ü—Ä–∏–Ω—è—Ç—å –ª–∏—Ü–µ–Ω–∑–∏–∏ Android (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
    - name: üìù Accept Android licenses
      run: |
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses || true
    
    # 8. –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏
    - name: üßπ Clean previous builds
      run: |
        buildozer android clean 2>/dev/null || true
        rm -rf .buildozer/android/platform/build-* 2>/dev/null || true
    
    # 9. –°–æ–±—Ä–∞—Ç—å APK (–æ—Å–Ω–æ–≤–Ω–æ–π —à–∞–≥)
    - name: üî® Build APK with Buildozer
      env:
        # –£—Å–∫–æ—Ä—è–µ–º —Å–±–æ—Ä–∫—É
        USE_CCACHE: 1
        CCACHE_DIR: /tmp/ccache
        BUILD_WITH_COLOR: 1
      run: |
        # –°–æ–∑–¥–∞—Ç—å –∫—ç—à –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        mkdir -p /tmp/ccache
        
        # –°–æ–±—Ä–∞—Ç—å APK —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–æ–º
        echo "üöÄ Starting build..."
        buildozer -v android debug
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if ls bin/*.apk 1>/dev/null 2>&1; then
          APK_FILE=$(ls bin/*.apk | head -1)
          echo "‚úÖ BUILD SUCCESS!"
          echo "üì¶ APK: $APK_FILE"
          echo "üìä Size: $(du -h "$APK_FILE" | cut -f1)"
        else
          echo "‚ùå BUILD FAILED - No APK found"
          exit 1
        fi
    
    # 10. –ó–∞–≥—Ä—É–∑–∏—Ç—å APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
    - name: ‚¨ÜÔ∏è Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: graphbuilder-apk
        path: bin/*.apk
        retention-days: 7
        if-no-files-found: error
    
    # 11. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ–∑–¥–∞—Ç—å Release –ø—Ä–∏ —Ç–µ–≥–µ
    - name: üè∑Ô∏è Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        generate_release_notes: true
        draft: false
        prerelease: false